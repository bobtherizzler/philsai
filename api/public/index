<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phils â€” Coding Assistant</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:       #1e2025;
    --surface:  #25282f;
    --surface2: #2c3040;
    --border:   #333742;
    --text:     #a8b0c0;
    --hi:       #c8d0e0;
    --dim:      #4a5468;
    --blue:     #4a7fd4;
    --blue-dim: rgba(74,127,212,0.12);
    --code-bg:  #181c22;
  }
  body { font-family: -apple-system,'Segoe UI',sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; font-size: 14px; line-height: 1.6; }

  #header { height: 48px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-mark { width: 28px; height: 28px; background: var(--blue); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
  .logo-name { font-weight: 600; color: var(--hi); font-size: 15px; }
  .logo-sub  { font-size: 11px; color: var(--dim); }
  #clear-btn { background: transparent; border: 1px solid var(--border); color: var(--dim); padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: inherit; display: none; }
  #clear-btn:hover { color: var(--text); border-color: var(--border); }

  #chat { flex: 1; overflow-y: auto; padding: 24px 0; scroll-behavior: smooth; }
  #chat::-webkit-scrollbar { width: 4px; }
  #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  #empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 20px; padding: 0 20px; }
  #empty h1 { font-size: 22px; font-weight: 700; color: var(--hi); letter-spacing: -0.02em; }
  #empty p  { font-size: 13px; color: var(--dim); }
  .suggestions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; max-width: 480px; width: 100%; }
  .sug { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; text-align: left; cursor: pointer; font-size: 12px; color: var(--dim); font-weight: 500; font-family: inherit; transition: all 0.12s; }
  .sug:hover { border-color: var(--blue); color: var(--blue); }

  .msg-wrap { max-width: 740px; margin: 0 auto 18px; padding: 0 20px; animation: fadeup 0.18s ease; }
  @keyframes fadeup { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
  .msg-user { display: flex; justify-content: flex-end; }
  .bubble-user { background: var(--surface); border: 1px solid var(--border); border-radius: 12px 12px 3px 12px; padding: 10px 14px; color: var(--hi); max-width: 78%; white-space: pre-wrap; word-wrap: break-word; }
  .msg-phils { display: flex; gap: 10px; }
  .av { width: 26px; height: 26px; background: var(--blue); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #fff; flex-shrink: 0; margin-top: 2px; }
  .phils-body { flex: 1; color: var(--text); line-height: 1.75; word-wrap: break-word; }
  .mode-tag { font-size: 10px; color: var(--dim); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.05em; }

  .phils-body h2 { font-size: 14px; font-weight: 700; color: var(--hi); margin: 16px 0 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
  .phils-body h3 { font-size: 13px; font-weight: 600; color: var(--text); margin: 12px 0 4px; }
  .phils-body p  { margin-bottom: 8px; }
  .phils-body p:last-child { margin-bottom: 0; }
  .phils-body ul, .phils-body ol { padding-left: 18px; margin-bottom: 8px; }
  .phils-body li { margin-bottom: 3px; }
  .phils-body strong { font-weight: 600; color: var(--hi); }
  .phils-body em { color: var(--dim); font-style: italic; }
  .phils-body a  { color: var(--blue); text-decoration: none; }
  .phils-body a:hover { text-decoration: underline; }
  .phils-body code { background: var(--surface2); border: 1px solid var(--border); padding: 1px 5px; border-radius: 3px; font-size: 0.88em; color: #5a8fd4; font-family: 'JetBrains Mono','Courier New',monospace; }

  .code-block { background: var(--code-bg); border: 1px solid var(--border); border-radius: 7px; overflow: hidden; margin: 10px 0; }
  .code-hdr { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; background: var(--surface2); border-bottom: 1px solid var(--border); }
  .code-lang { font-size: 11px; color: var(--dim); font-family: monospace; letter-spacing: 0.05em; }
  .copy-btn { background: transparent; border: 1px solid var(--border); color: var(--dim); padding: 2px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-family: monospace; transition: all 0.12s; }
  .copy-btn:hover, .copy-btn.copied { border-color: var(--blue); color: var(--blue); }
  .code-block pre { margin: 0; padding: 14px 16px; overflow-x: auto; font-size: 13px; line-height: 1.65; color: #b8c0d0; font-family: 'JetBrains Mono','Courier New',monospace; white-space: pre; }

  .thinking { display: flex; align-items: center; gap: 8px; color: var(--dim); font-size: 12px; }
  .dots span { display: inline-block; width: 5px; height: 5px; border-radius: 50%; background: var(--dim); animation: blink 1.2s infinite; margin-right: 4px; }
  .dots span:nth-child(2){animation-delay:.2s;} .dots span:nth-child(3){animation-delay:.4s;}
  @keyframes blink { 0%,80%,100%{opacity:.2;} 40%{opacity:1;} }

  .error-wrap { max-width: 740px; margin: 0 auto 16px; padding: 0 20px; }
  .error-box { background: #2a1a1a; border: 1px solid #4a2525; border-radius: 7px; padding: 10px 14px; color: #c06060; font-size: 13px; }

  #input-area { background: var(--surface); border-top: 1px solid var(--border); padding: 12px 20px 14px; flex-shrink: 0; }
  .input-inner { max-width: 740px; margin: 0 auto; }
  .mode-tabs { display: flex; gap: 4px; margin-bottom: 8px; align-items: center; }
  .mode-tab { background: transparent; border: 1px solid var(--border); border-radius: 6px; padding: 4px 12px; font-size: 11px; font-weight: 500; color: var(--dim); cursor: pointer; font-family: inherit; transition: all 0.12s; }
  .mode-tab.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); font-weight: 600; }
  .mode-desc { font-size: 11px; color: var(--dim); margin-left: 4px; }
  .ta-box { background: var(--bg); border: 1px solid var(--border); border-radius: 9px; overflow: hidden; transition: border-color 0.15s; }
  .ta-box:focus-within { border-color: var(--blue); }
  #msg { width: 100%; background: transparent; border: none; outline: none; resize: none; color: var(--hi); font-size: 14px; line-height: 1.6; padding: 11px 14px 0; font-family: inherit; min-height: 44px; max-height: 160px; overflow-y: auto; }
  #msg::placeholder { color: var(--dim); }
  .ta-footer { display: flex; align-items: center; justify-content: space-between; padding: 5px 8px 8px; }
  .ta-hint { font-size: 10px; color: var(--dim); }
  #send { background: var(--blue); border: none; color: #fff; padding: 6px 18px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.15s; }
  #send:hover { background: #5a8fe0; }
  #send:disabled { background: var(--surface2); color: var(--dim); cursor: not-allowed; }
</style>
</head>
<body>

<div id="header">
  <div class="logo">
    <div class="logo-mark">P/</div>
    <span class="logo-name">Phils</span>
    <span class="logo-sub">coding assistant</span>
  </div>
  <button id="clear-btn" onclick="clearChat()">Clear</button>
</div>

<div id="chat">
  <div id="empty">
    <h1>What can I help you build?</h1>
    <p>Paste code, describe a problem, or ask anything about software.</p>
    <div class="suggestions" id="sug-grid"></div>
  </div>
</div>

<div id="input-area">
  <div class="input-inner">
    <div class="mode-tabs" id="mode-tabs"></div>
    <div class="ta-box">
      <textarea id="msg" rows="1" placeholder="Ask anything about code..."></textarea>
      <div class="ta-footer">
        <span class="ta-hint">Enter to send, Shift+Enter for new line</span>
        <button id="send" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const MODES = {
  auto: {
    label: "Auto", desc: "Adapts depth to your question",
    system: `You are Phils, an elite coding assistant with expert-level knowledge across all languages, frameworks, and software engineering.
- Calibrate depth: simple questions get concise answers (2-5 lines), complex ones get thorough treatment.
- Find root causes, not just symptoms.
- If a better approach exists, say so first, then answer the literal question.
- Flag bugs, security issues, or performance problems in any shared code even if not asked.
- Never use filler phrases. Start directly with the answer.
- Always use fenced code blocks with language identifier.
- Write production-quality code. Handle errors and edge cases.
- Use ## headers for multi-section answers. Conclusion first, reasoning after.`
  },
  fast: {
    label: "Fast", desc: "Direct, minimal words",
    system: `You are Phils, a coding assistant optimised for speed.
- Fewest words that fully answer the question.
- Lead with code. Explain only what is essential.
- No preamble, no filler.
- Always fenced code blocks with language identifier.`
  },
  deep: {
    label: "Deep", desc: "Full reasoning, thorough analysis",
    system: `You are Phils, an expert coding assistant doing deep technical analysis.
Structure every response:
1. State the core problem in one sentence.
2. Identify hidden assumptions or constraints.
3. Present 2-3 approaches with explicit tradeoffs.
4. Recommend one with clear justification.
5. Provide a complete, production-ready implementation.
6. List gotchas, edge cases, and production concerns.
No pseudocode, no TODOs. Complete working code only. Always fenced code blocks.`
  }
};

const SUGGESTIONS = [
  { label: "Debug",       prompt: "I have a bug I cannot figure out:\n\n" },
  { label: "Code review", prompt: "Review this code and tell me what is wrong:\n\n" },
  { label: "Refactor",    prompt: "Refactor this to be cleaner:\n\n" },
  { label: "Explain",     prompt: "Explain this concept clearly: " },
  { label: "Write tests", prompt: "Write tests for this:\n\n" },
  { label: "Architect",   prompt: "Help me think through the architecture for: " },
];

let messages = [], mode = "auto", busy = false;

// Build mode tabs
const tabs = document.getElementById("mode-tabs");
Object.entries(MODES).forEach(([k, v]) => {
  const b = document.createElement("button");
  b.className = "mode-tab" + (k === mode ? " active" : "");
  b.textContent = v.label; b.dataset.mode = k;
  b.onclick = () => {
    mode = k;
    document.querySelectorAll(".mode-tab").forEach(t => t.classList.toggle("active", t.dataset.mode === k));
    document.getElementById("mode-desc").textContent = MODES[k].desc;
  };
  tabs.appendChild(b);
});
const descEl = document.createElement("span");
descEl.className = "mode-desc"; descEl.id = "mode-desc";
descEl.textContent = MODES[mode].desc;
tabs.appendChild(descEl);

// Build suggestions
const grid = document.getElementById("sug-grid");
SUGGESTIONS.forEach(s => {
  const b = document.createElement("button");
  b.className = "sug"; b.textContent = s.label;
  b.onclick = () => { document.getElementById("msg").value = s.prompt; resize(); document.getElementById("msg").focus(); };
  grid.appendChild(b);
});

// Textarea
const ta = document.getElementById("msg");
ta.addEventListener("input", resize);
ta.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMsg(); } });

function resize() {
  ta.style.height = "auto";
  ta.style.height = Math.min(ta.scrollHeight, 160) + "px";
}

function esc(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function md(text) {
  const parts = []; const rx = /```(\w*)\n?([\s\S]*?)```/g;
  let last = 0, m;
  while ((m = rx.exec(text)) !== null) {
    if (m.index > last) parts.push({ t:"text", c:text.slice(last,m.index) });
    parts.push({ t:"code", lang:m[1]||"code", c:m[2].trim() });
    last = m.index + m[0].length;
  }
  if (last < text.length) parts.push({ t:"text", c:text.slice(last) });

  return parts.map(p => {
    if (p.t === "code") return `<div class="code-block"><div class="code-hdr"><span class="code-lang">${esc(p.lang)}</span><button class="copy-btn">copy</button></div><pre>${esc(p.c)}</pre></div>`;
    let h = esc(p.c);
    h = h.replace(/^## (.+)$/gm,"<h2>$1</h2>");
    h = h.replace(/^### (.+)$/gm,"<h3>$1</h3>");
    h = h.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");
    h = h.replace(/\*(.+?)\*/g,"<em>$1</em>");
    h = h.replace(/`([^`]+)`/g,"<code>$1</code>");
    h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
    h = h.replace(/^- (.+)$/gm,"<li>$1</li>");
    h = h.replace(/^(\d+)\. (.+)$/gm,"<li>$2</li>");
    h = h.replace(/(<li>[\s\S]*?<\/li>\n?)+/g, w=>`<ul>${w}</ul>`);
    h = h.split(/\n\n+/).map(b => {
      const t = b.trim();
      if (!t || /^<[huo]/.test(t)) return t;
      return `<p>${t.replace(/\n/g,"<br>")}</p>`;
    }).join("");
    return h;
  }).join("");
}

function wireCodeBlocks(el) {
  el.querySelectorAll(".copy-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      navigator.clipboard.writeText(btn.closest(".code-block").querySelector("pre").innerText);
      btn.textContent = "copied"; btn.classList.add("copied");
      setTimeout(() => { btn.textContent = "copy"; btn.classList.remove("copied"); }, 2000);
    });
  });
}

function scrollBottom() { const c = document.getElementById("chat"); c.scrollTop = c.scrollHeight; }

function hideEmpty() {
  document.getElementById("empty").style.display = "none";
  document.getElementById("clear-btn").style.display = "inline";
}

function clearChat() {
  messages = [];
  const chat = document.getElementById("chat");
  Array.from(chat.children).forEach(el => { if (el.id !== "empty") el.remove(); });
  document.getElementById("empty").style.display = "flex";
  document.getElementById("clear-btn").style.display = "none";
}

function addEl(html, wireCopy) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.innerHTML = html;
  const el = div.firstElementChild;
  chat.appendChild(el);
  if (wireCopy) wireCodeBlocks(el);
  scrollBottom();
  return el;
}

async function sendMsg() {
  if (busy) return;
  const text = ta.value.trim();
  if (!text) return;

  busy = true;
  document.getElementById("send").disabled = true;
  ta.value = ""; ta.style.height = "auto"; ta.disabled = true;
  hideEmpty();

  const currentMode = mode;
  messages.push({ role: "user", content: text });

  addEl(`<div class="msg-wrap"><div class="msg-user"><div class="bubble-user">${esc(text)}</div></div></div>`);

  const thinkEl = addEl(`<div class="msg-wrap" id="thinking">
    <div class="msg-phils">
      <div class="av">P/</div>
      <div class="phils-body">
        <div class="thinking">
          <div class="dots"><span></span><span></span><span></span></div>
          <span>${currentMode === "deep" ? "thinking deeply" : currentMode === "fast" ? "answering fast" : "thinking"}</span>
        </div>
      </div>
    </div>
  </div>`);

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages, system: MODES[currentMode].system }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const reply = data.text;
    messages.push({ role: "assistant", content: reply });
    thinkEl.remove();

    const modeTag = currentMode !== "auto" ? `<div class="mode-tag">${MODES[currentMode].label} mode</div>` : "";
    addEl(`<div class="msg-wrap"><div class="msg-phils"><div class="av">P/</div><div class="phils-body">${modeTag}${md(reply)}</div></div></div>`, true);

  } catch (err) {
    messages.pop();
    thinkEl.remove();
    addEl(`<div class="error-wrap"><div class="error-box">${esc(err.message || "Something went wrong.")}</div></div>`);
  } finally {
    busy = false;
    document.getElementById("send").disabled = false;
    ta.disabled = false;
    ta.focus();
  }
}
</script>
</body>
</html>
